---
title: "metaDataAllScopeStop"
author: "Melanie Smith"
date: "13 September 2023"
output: html_document
---

# Load required libraries
```{r load Libraries}
library(plyr)
library(reshape2)
library(dplyr)
library(stringr)
library(edgeR)
library(readxl)
library(readr)
library(magrittr)
library(tibble)
library(ggplot2)
library(ggrepel)
library(pheatmap)

# set project directory
projectDir <- "/home/smit1924/preeclampsia_sex_chromosome_informed"
dataFolder <- "/home/smit1924/dataFolder"

expt_name <- 'metaData_SCOPE_STOP'

SCOPE_dataDictionary_file <- file.path("/media/sf_D_DRIVE/VM_Projects/dataFolder/Data_dictionary_FINAL_DISTR_updated_130215_biomarker_SNP.xlsx")
SCOPE_raw_file <- file.path("/media/sf_D_DRIVE/VM_Projects/dataFolder/SCOPE_full_raw_20141201.rds")
STOP_raw_dat_file <- file.path(dataFolder,"STOPStudy_DATA_2021-04-23_1151.csv")
STOP_raw_dict_file <- file.path(dataFolder,"STOPStudy_DataDictionary_2021-04-23.csv")
metadata_file <- file.path(projectDir, "clearBoxRawData/cleanSampleMetadata.csv")

outdir <- file.path(projectDir, paste0(expt_name, "_output"))

dir.create(outdir)

# REDCap import
source("/media/sf_D_DRIVE/VM_Projects/dataFolder/redcap_api_import.R")

```

# Import sample names and metadata table
- we will use this to subset the filtered data
```{r}
sample_names <- readRDS("~/preeclampsia_sex_chromosome_informed/clearBoxCleanData/sample_names.rds")
metadata <- read_csv(file = metadata_file)
```


# Import SCOPE
```{r}

# import the full SCOPE metadata file
SCOPE_raw <- readRDS(SCOPE_raw_file)

# import SCOPE full data dictionary
SCOPE_dataDictionary <- read_excel(SCOPE_dataDictionary_file,
                                   sheet = "Stage 1 Data") %>%
  as.data.frame()

# SCOPE BP variables of interest 
SCOPE_variables <- c("f11c_1st_vst_map_1st", "f11c_1st_vst_map_2nd", "f24_Max_sBP", "f24_Max_dBP")

# filter
filter_SCOPE_dataDictionary <- subset(SCOPE_dataDictionary, Variable_SAS_name %in% SCOPE_variables)


# subset to the required columns
subsetSCOPE <- dplyr::select(SCOPE_raw, regid, centre, all_of(SCOPE_variables)) %>% 
  # remove all centres except Adelaide
  dplyr::filter(., centre == "Adelaide University") %>% 
    # sort by ID
  dplyr::arrange(., regid) %>% 
  # add a samplename column that matches the rest of my data
  dplyr::mutate(., samplename = paste0("SCP", stringr::str_pad(regid, width=4, pad="0"))) %>%
  # make samplename the first column and drop column 'centre'
  dplyr::select(., samplename, everything(), -centre) %>% 
  # replace all the missing data codes with NA
  mutate(across(everything(), function(x){replace(x, which(x<0), NA)}))
head(subsetSCOPE)
dim(subsetSCOPE)

# subset to include on the samples in the PE study
subsetSCOPE %<>% subset(., samplename %in% sample_names)

# use dplyr::mutate to make new sbp and dbp columns for the rbind
SCOPE_sbp_dbp <- subsetSCOPE %>%
  dplyr::mutate(., sbp = f24_Max_sBP,
                dbp = f24_Max_dBP) %>%
  dplyr::select(., samplename, sbp, dbp)
```

# Import STOP

```{r import STOP}

# STOP BP variables of interest 
STOP_bloodPressure <- c("participant_id", "f9_sbp", "f9_dbp", "f20_max_sbp_dbp", "f20_sbp_max_dbp")

# STOP (REDCap import)
STOP_raw_dat <- read.csv("/media/sf_D_DRIVE/VM_Projects/dataFolder/STOPStudy_DATA_2021-04-23_1151.csv",
                         header = TRUE)
STOP_raw_dict <- read.csv(file.path("/media/sf_D_DRIVE/VM_Projects/dataFolder/STOPStudy_DataDictionary_2021-04-23.csv"
  ),
                          header = TRUE)

STOP_raw <- apply_data_dict(STOP_raw_dat,STOP_raw_dict)
table(STOP_raw$final_data) #use final data subset (N=1300) only

# subset for the variables we want
subsetSTOP <- dplyr::select(STOP_raw, final_data, all_of(STOP_bloodPressure)) %>%
  # drop samples not in the final data subset
  dplyr::filter(., final_data == "Yes") %>% 
  # sort by ID
  dplyr::arrange(., participant_id) %>% 
  # add a samplename column that matches the rest of my data
  dplyr::mutate(., samplename = paste0(
    "STP", stringr::str_pad(participant_id, width = 4, pad = "0"))
    ) %>%
  # make samplename the first column
  dplyr::select(., samplename, everything())

subsetSTOP %<>% subset(., samplename %in% sample_names)

# Create new columns by splitting at "/"
subsetSTOP$sbp <- sapply(strsplit(as.character(subsetSTOP$f20_max_sbp_dbp), "/"), function(x) x[1])
subsetSTOP$dbp <- sapply(strsplit(as.character(subsetSTOP$f20_max_sbp_dbp), "/"), function(x) ifelse(length(x) > 1, x[2], NA))

# Convert to numeric
subsetSTOP$sbp <- as.numeric(subsetSTOP$sbp)
subsetSTOP$dbp <- as.numeric(subsetSTOP$dbp)

# use dplyr::select to keep only the columns needed for the rbind
STOP_sbp_dbp <- dplyr::select(subsetSTOP, samplename, sbp, dbp)


## for most samples in STOP there is a recorded measurement for highest sbp (f20_max_sbp_dbp) and highest dbp (f20_sbp_max_dbp) in the format sbp/dbp
## These may or may not be from the same BP measurement.
## We chose here to use the data from the highest sbp measurement here.
## One sample, STP0903 has the highest sbp and dbp listed on their own so when I split the column we end up with an NA for the dbp.
## Here I will add the dbp back in
STOP_sbp_dbp$dbp[STOP_sbp_dbp$samplename == "STP0903"] <- 68


```

## Combine the two sbp dbp objects

```{r}

combined_sbp_dbp <- rbind(SCOPE_sbp_dbp, STOP_sbp_dbp) %>%
  dplyr::left_join(., metadata, by = "samplename")

## mutate the group names (ie from M_Control to M_Unc and from F_Control to F_Unc)
plot_data <- combined_sbp_dbp %>%
  dplyr::mutate(new_sex_outcome = dplyr::case_when(
    sex_outcome == "M_PE" ~ "M_PE",
    sex_outcome == "F_PE" ~ "F_PE",
    sex_outcome == "M_Control" ~ "M_Un",
    sex_outcome == "F_Control" ~ "F_Un",
    TRUE ~ NA_character_  # This handles any unexpected values
  )) %>%
  dplyr::mutate(., new_sex_outcome = factor(new_sex_outcome, levels = c("F_Un", "F_PE", "M_Un", "M_PE")))



```

## Make some plots
```{r}
# Create the scatter plot
ggplot(plot_data, aes(x = sbp, y = dbp, color = sex_outcome, shape = cohort)) +
  geom_hline(yintercept = 90, linetype = "dashed", color = "black", size = 0.8) +
  geom_vline(xintercept = 140, linetype = "dashed", color = "black", size = 0.8) +
  geom_point(alpha = 0.7, size = 3) +
  scale_color_manual(values = c("palegreen3", "#004000", "plum3", "#2A0052"), name = "Sex Outcome") +
  scale_shape_manual(values = c(16, 17, 18, 15, 8), name = "Cohort") +
  labs(
    title = "Relationship between Systolic and Diastolic Blood Pressure",
    x = "Systolic Blood Pressure (mmHg)",
    y = "Diastolic Blood Pressure (mmHg)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 11, face = "bold")
  )


# Create violin plot with boxplot: SBP by sex outcome
ggplot(plot_data, aes(x = sex_outcome, y = sbp, fill = sex_outcome)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  geom_boxplot(width = 0.1, fill = "white", alpha = 0.5) +
  # scale_fill_brewer(palette = "Set1") +
  labs(
    title = "Distribution of Systolic Blood Pressure by Sex and Outcome",
    x = "Sex",
    y = "Systolic Blood Pressure (mmHg)"
  ) +
    theme_bw() +  # Clean theme
  scale_fill_manual(values = c("palegreen3", "#004000",  "plum3", "#2A0052")) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 11)
  ) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "black")

# Violin plot with jittered points: SBP by sex outcome
ggplot(plot_data, aes(x = sex_outcome, y = sbp, fill = sex_outcome)) +
  geom_violin(trim = FALSE, alpha = 0.7) +
  geom_jitter(width = 0.15, size = 1.5, alpha = 0.6, shape = 21, color = "black", fill = "white") +
  labs(
    title = "Distribution of Systolic Blood Pressure by Sex and Outcome",
    x = "Sex",
    y = "Systolic Blood Pressure (mmHg)"
  ) +
  theme_bw() +  # Clean theme
  scale_fill_manual(values = c("palegreen3", "#004000", "plum3", "#2A0052")) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text.x = element_text(size = 11)
  ) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "black")

```

