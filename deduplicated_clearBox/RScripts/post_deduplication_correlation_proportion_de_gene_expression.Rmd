---
title: "post_dedup_correlation_cell_type_de"
author: "Melanie Smith"
date: "29 July 2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE,
    cache = FALSE,
    fig.show='hold',
    fig.align = "center",
    results = "hide"
)

```

# Load required libraries

```{r load Libraries}
library(plyr)
library(reshape2)
library(dplyr)
library(tidyr)
library(stringr)
library(edgeR)
library(readxl)
library(readr)
library(magrittr)
library(tibble)
library(ggplot2)
library(ggbeeswarm)
library(ggrepel)
library(ggExtra)
library(pheatmap)

```

```{r}
# set project directory
projectDir <- "/home/smit1924/preeclampsia_sex_chromosome_informed"

# file paths for files to be imported

input_dge_list_obj_file <- file.path(projectDir, "deduplicated_clearBox/output/filt_norm_dgelist_58_post_dedup.rds")
input_tpm_table_file <- file.path(projectDir, "deduplicated_clearBox/output/tpm_allSample_deduplicated_bulkCountMatrix.txt")
input_metadata_quality_file <- file.path(projectDir, "clearBoxCleanData/metadata_quality.csv")
input_allTable_female_file <- file.path(projectDir, "deduplicated_clearBox/output/allTable_female_post_dedup.csv")
input_allTable_male_file <- file.path(projectDir, "deduplicated_clearBox/output/58_sample_noCovariate/allTable_male.csv")
gene_info_file <- file.path(projectDir, "clearBoxCleanData/gencode_v29_gene_id_symbol_chr_biotype.csv")

input_cibersortx_post_dedup_proportions_file <- file.path(projectDir, "deduplicated_clearBox/cibersortx_output/CIBERSORTx_Job10_Adjusted.txt")
input_cibersortx_sigMatrix_file <- file.path(projectDir, "cibersortx_reduced_sigMatrix/outdir/CIBERSORTx_sigmatrix_Adjusted.txt")


# file paths for output files
outdir <- file.path("/media/sf_D_DRIVE/VM_Projects/20240619_deduplicateBams/plots")

out_final_correlation_results_80percent_file <- file.path(projectDir, "deduplicated_clearBox/output/final_correlation_results_80percent.csv")
out_file_cibersortx_stats <- file.path(projectDir, "cibersortx_stats.xlsx")

out_file_oddsRatio_stats_male <- file.path(outdir, "out_file_oddsRatio_stats_male.xlsx")
out_file_oddsRatio_stats_female <- file.path(outdir, "out_file_oddsRatio_stats_female.xlsx")

# create directories for output files

dir.create(outdir)

# set max digits
options(digits=3)

`%notin%` <- Negate(`%in%`)

```

# Import files

```{r}
# import the DGEList object used in the post deduplication DE analysis
dge_list_obj <- readRDS(input_dge_list_obj_file)

# import the tpm table calculated for the post deduplication cibersortx run
tpm_table <- read.table(file = input_tpm_table_file,
                        header = TRUE,
                        sep = "\t")
colnames(tpm_table) <- stringr::str_remove(colnames(tpm_table), "_dedup")

# import the metadata file
metadata_quality <- read_csv(file = input_metadata_quality_file)

# import the allTables from the post deduplication DE
allTable_female <- read_csv(file = input_allTable_female_file)
allTable_male <- read_csv(file = input_allTable_male_file)

# import the V29 gene unformation file
gene_info <- read_csv(file = gene_info_file)

# import the post deduplication cibersortx proportions
cibersortx_post_dedup_proportions <- read.table(file = input_cibersortx_post_dedup_proportions_file,
                                                header = TRUE,
                                                sep = "\t") %>%
  dplyr::select(., samplename = Mixture, everything()) %>%
  dplyr::select(., -'P.value', -'Correlation', -'RMSE') %>%
  dplyr::mutate(., samplename = stringr::str_remove(samplename, "_dedup")) #%>%
  # subset(., samplename %notin% c("SCP4060", "SCP3492", "SCP4010"))

# import the cibersort signature matrix (reduced cell types and after adjustment)
cibersortx_reduced_sigMatrix <- read.table(file = input_cibersortx_sigMatrix_file,
                                           header = TRUE,
                                           sep = "\t")

# remove rows that contain all zero counts in the signature matrix
cibersortx_reduced_sigMatrix <- cibersortx_reduced_sigMatrix[rowSums(cibersortx_reduced_sigMatrix[,-1])>0,]
dim(cibersortx_reduced_sigMatrix)


```

```{r}
# differnce on GA between all PE and Control
t_test_result <- t.test(GestationalAge ~ Outcome, data = metadata_quality)
# Mean difference
mean_difference <- t_test_result$estimate[2] - t_test_result$estimate[1]

# P-value
p_value <- t_test_result$p.value

# difference in GA between males only
# Parametric test (t-test)
t_test_result_male <- t.test(GestationalAge ~ sex_outcome, 
                             data = metadata_quality, 
                             subset = sex_outcome %in% c("M_PE", "M_Control"))
# Mean difference
mean_difference_male <- t_test_result_male$estimate[2] - t_test_result_male$estimate[1]

# P-value
p_value_male <- t_test_result_male$p.value

# difference in GA between males only
t_test_result_female <- t.test(GestationalAge ~ sex_outcome, 
                             data = metadata_quality, 
                             subset = sex_outcome %in% c("F_PE", "F_Control"))
# Mean difference
mean_difference_female <- t_test_result_female$estimate[2] - t_test_result_female$estimate[1]

# P-value
p_value_female <- t_test_result_female$p.value

```


## CIBERSORTx outcome data for the paper

```{r}

# import the post deduplication cibersortx proportions
cibersortx_stats <- read.table(file = input_cibersortx_post_dedup_proportions_file,
                               header = TRUE,
                               sep = "\t") %>%
  dplyr::select(samplename = Mixture, everything()) %>%
   # remove the traiing "_dedup" from the samplename
  dplyr::mutate(samplename = gsub("_dedup$", "", samplename)) %>%
  # keep only the 58 final samples
  inner_join(metadata_quality[, c("samplename")], by = "samplename")

# save a table of cibersortx output for the paper
library(writexl)

# Write the dataframe to an Excel file
write_xlsx(cibersortx_stats, out_file_cibersortx_stats)

# Calculate the mean and standard deviation for the `Correlation` column
correlation_mean <- mean(cibersortx_stats$Correlation, na.rm = TRUE)
correlation_sd <- sd(cibersortx_stats$Correlation, na.rm = TRUE)

# Calculate the mean and standard deviation for the `RMSE` column
rmse_mean <- mean(cibersortx_stats$RMSE, na.rm = TRUE)
rmse_sd <- sd(cibersortx_stats$RMSE, na.rm = TRUE)

# Print results
cat("Correlation - Mean:", correlation_mean, "SD:", correlation_sd, "\n")
cat("RMSE - Mean:", rmse_mean, "SD:", rmse_sd, "\n")

# Select columns to include (exclude "samplename", "P.value", "Correlation", "RMSE")
filtered_data <- cibersortx_stats[, !(colnames(cibersortx_stats) %in% c("samplename", "P.value", "Correlation", "RMSE"))]

# Calculate mean and standard deviation for each cell type for all samples
cellTypes_allSamples <- data.frame(
  Column = colnames(filtered_data),
  Mean = colMeans(filtered_data, na.rm = TRUE)*100,
  SD = apply(filtered_data, 2, sd, na.rm = TRUE)*100
)

# Calculate mean and standard deviation for each cell type for samples by sex

# Remove trailing "_dedup" from the `samplename` column in cibersortx_stats
cibersortx_stats$samplename <- gsub("_dedup$", "", cibersortx_stats$samplename)
# Join cibersortx_stats with metadata_quality by "samplename"
merged_data <- cibersortx_stats %>%
  inner_join(metadata_quality[, c("samplename", "sex_outcome")], by = "samplename")  # Merge based on "samplename"

# Exclude specific columns from analysis (P.value, Correlation, RMSE)
filtered_data <- merged_data %>%
  dplyr::select(-P.value, -Correlation, -RMSE)

# Group by "Sex" and calculate mean and SD for each column
result <- filtered_data %>%
  group_by(sex_outcome) %>%
  summarise(across(where(is.numeric), 
                   list(Mean = ~mean(.x, na.rm = TRUE), 
                        Median = ~median(.x, na.rm = TRUE),
                        SD = ~sd(.x, na.rm = TRUE)),
                   .names = "{col}_{fn}")) %>% # Create column names dynamically
  tibble::column_to_rownames("sex_outcome") %>%
  t()

# Return the resulting data frame
t(result)
```

# test cell-type proportions differences
## Male
- this uses the beta regression suggested in the Campbell _et al._ paper 

```{r}
# perform beta regression to determine if there are cell-type differences based on outcome
# with columns for cell types, case_control, fetal_sex, and gestational_age

# Function to perform beta regression for a single cell type
# Load required libraries
library(betareg)
library(tidyverse)
library(broom)

# Function to perform beta regression for a single cell type
perform_beta_regression <- function(cell_type, data) {
  # Transform data to ensure all values are between 0 and 1
  data[[cell_type]] <- (data[[cell_type]] * (nrow(data) - 1) + 0.5) / nrow(data)
  
  formula <- as.formula(paste(cell_type, "~ Outcome + GestationalAge"))
  
  tryCatch({
    model <- betareg(formula, data = data)
    
    # Extract results
    results <- tidy(model) %>%
      filter(term == "OutcomePE") %>%
      mutate(cell_type = cell_type,
             odds_ratio = exp(estimate),
             ci_lower = exp(estimate - 1.96 * std.error),
             ci_upper = exp(estimate + 1.96 * std.error))
    
    return(results)
  }, error = function(e) {
    warning(paste("Error in cell type:", cell_type, "- ", e$message))
    return(NULL)
  })
}

# List of cell type columns
cell_types <- c("Fetal.Mesenchymal.Stem.Cells", "CD14..Monocytes", "CD8..Activated.T.Cells", "Naive.CD4..T.Cells",
                "Naive.CD8..T.Cells", "Natural.Killer.T.Cells", "B.Cells", "Fetal.GZMK..Natural.Killer", "Fetal.Memory.CD4..T.Cells",
                "Fetal.Hofbauer.Cells", "Fetal.Plasmacytoid.Dendritic.Cells", "Fetal.GZMB..Natural.Killer", "Fetal.Endothelial.Cells",
                "Fetal.Syncytiotrophoblast", "Fetal.Fibroblasts", "Cytotrophoblast", "Fetal.Nucleated.Red.Blood.Cells", "Maternal.FCGR3A..Monocytes",
                "Maternal.Plasma.Cells", "Fetal.Extravillous.Trophoblasts")

# Filter metadata to include samples where Sex = "M" (male)
filtered_metadata <- metadata_quality %>%
  filter(Sex == "M")

# Prepare the data
df <- dplyr::left_join(filtered_metadata, cibersortx_stats, by = "samplename") %>%
  dplyr::select(all_of(c(cell_types, "Outcome", "GestationalAge")))

# Check for any NAs or infinite values
df <- df %>% drop_na()

# Perform beta regression for each cell type
results_list <- lapply(cell_types, perform_beta_regression, data = df)

# Remove NULL results (if any errors occurred)
results_list <- results_list[!sapply(results_list, is.null)]

# Combine results
final_results <- bind_rows(results_list)

# View results
print(final_results)

final_results <- final_results %>%
  mutate(
    significant = (ci_lower > 1 | ci_upper < 1),
    direction = case_when(
      odds_ratio > 1 & significant ~ "Higher in PE",
      odds_ratio < 1 & significant ~ "Lower in PE",
      TRUE ~ "No significant difference"
    )
  )
# Write the dataframe to an Excel file
# write_xlsx(final_results, out_file_oddsRatio_stats_male)

# Updated ggplot code
ggplot(final_results, aes(x = reorder(cell_type, odds_ratio), y = odds_ratio)) +
  geom_point(aes(color = direction), size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, color = direction), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("Higher in PE" = "red", "Lower in PE" = "blue", "No significant difference" = "gray")) +
  scale_y_log10() +  # Use log scale for better visualization of ratios
  labs(title = "Odds Ratios for Cell Type Proportions in Preeclampsia (Male)",
       x = "Cell Type",
       y = "Odds Ratio (95% CI, log scale)",
       color = "Association with PE") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8),
        legend.position = "bottom")

# If you want to save the plot
# ggsave("cell_type_odds_ratios_PE.png", width = 12, height = 10, dpi = 300)

# Print a summary table
summary_table <- final_results %>%
  dplyr::select(cell_type, odds_ratio, ci_lower, ci_upper, direction) %>%
  arrange(desc(odds_ratio))

print(summary_table)

```

## Female

```{r}

# Filter metadata to include samples where Sex = "F" (Female)
filtered_metadata_F <- metadata_quality %>%
  filter(Sex == "F")

# Prepare the data
df_F <- dplyr::left_join(filtered_metadata_F, cibersortx_stats, by = "samplename") %>%
  dplyr::select(all_of(c(cell_types, "Outcome", "GestationalAge")))

# Check for any NAs or infinite values
df_F <- df_F %>% drop_na()

# Perform beta regression for each cell type
results_list_F <- lapply(cell_types, perform_beta_regression, data = df_F)

# Remove NULL results (if any errors occurred)
results_list_F <- results_list_F[!sapply(results_list_F, is.null)]

# Combine results
final_results_F <- bind_rows(results_list_F)

# View results
print(final_results_F)

final_results_F <- final_results_F %>%
  mutate(
    significant = (ci_lower > 1 | ci_upper < 1),
    direction = case_when(
      odds_ratio > 1 & significant ~ "Higher in PE",
      odds_ratio < 1 & significant ~ "Lower in PE",
      TRUE ~ "No significant difference"
    )
  )
# Write the dataframe to an Excel file
# write_xlsx(final_results_F, out_file_oddsRatio_stats_female)

# Updated ggplot code
ggplot(final_results_F,
       aes(x = reorder(cell_type, odds_ratio), y = odds_ratio)) +
  geom_point(aes(color = direction), size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, color = direction), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("Higher in PE" = "red", "Lower in PE" = "blue", "No significant difference" = "gray")) +
  scale_y_log10() +  # Use log scale for better visualization of ratios
  labs(title = "Odds Ratios for Cell Type Proportions in Preeclampsia",
       x = "Cell Type",
       y = "Odds Ratio (95% CI, log scale)",
       color = "Association with PE") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8),
        legend.position = "bottom")

# If you want to save the plot
# ggsave("cell_type_odds_ratios_PE.png", width = 12, height = 10, dpi = 300)

# Print a summary table
summary_table_F <- final_results_F %>%
  select(cell_type, odds_ratio, ci_lower, ci_upper, direction) %>%
  arrange(desc(odds_ratio))

print(summary_table_F)
```
## Combined male and female plots

```{r}
# Determine the order of cell types based on descending odds ratio in male results
cell_type_order <- final_results %>%
  arrange(desc(odds_ratio)) %>%
  pull(cell_type)

# Ensure all cell types are included in both datasets and align the order
all_cell_types <- unique(c(final_results$cell_type, final_results_F$cell_type))
final_results <- final_results %>%
  complete(cell_type = all_cell_types, fill = list(odds_ratio = NA, ci_lower = NA, ci_upper = NA, direction = "No significant difference")) %>%
  mutate(cell_type = factor(cell_type, levels = cell_type_order))

final_results_F <- final_results_F %>%
  complete(cell_type = all_cell_types, fill = list(odds_ratio = NA, ci_lower = NA, ci_upper = NA, direction = "No significant difference")) %>%
  mutate(cell_type = factor(cell_type, levels = cell_type_order))

# Calculate a common x-axis range for the odds ratio
common_x_limits <- range(c(final_results$ci_lower, final_results$ci_upper, final_results_F$ci_lower, final_results_F$ci_upper), na.rm = TRUE)

# Generate the male plot
male_plot <- ggplot(final_results, aes(x = cell_type, y = odds_ratio)) +
  geom_point(aes(color = direction), size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, color = direction), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("Higher in PE" = "red", "Lower in PE" = "blue", "No significant difference" = "gray")) +
  scale_y_log10(limits = common_x_limits) +  # Apply common x-axis limits
  labs(title = "Odds Ratios for Cell Type Proportions in Preeclampsia (Male)",
       x = "Cell Type",
       y = "Odds Ratio (95% CI, log scale)",
       color = "Association with PE") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8),
        legend.position = "bottom")

# Generate the female plot
female_plot <- ggplot(final_results_F, aes(x = cell_type, y = odds_ratio)) +
  geom_point(aes(color = direction), size = 3) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper, color = direction), width = 0.2) +
  coord_flip() +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("Higher in PE" = "red", "Lower in PE" = "blue", "No significant difference" = "gray")) +
  scale_y_log10(limits = common_x_limits) +  # Apply common x-axis limits
  labs(title = "Odds Ratios for Cell Type Proportions in Preeclampsia (Female)",
       x = "Cell Type",
       y = "Odds Ratio (95% CI, log scale)",
       color = "Association with PE") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8),
        legend.position = "bottom")

# Print and save the plots
print(male_plot)
ggsave(paste0(outdir, "/cell_type_odds_ratios_PE_male.png"), width = 12, height = 10, dpi = 300)
print(female_plot)
ggsave(paste0(outdir, "/cell_type_odds_ratios_PE_female.png"), width = 12, height = 10, dpi = 300)

```


# Ridgeline plot of cell type proportions

```{r}
library(ggplot2)
library(ggridges)


# Remove specified columns
cibersort_plot_data <- cibersortx_stats %>% 
  select(-c(P.value, Correlation, RMSE))

# Reshape to long format
cibersort_long <- cibersort_plot_data %>%
  pivot_longer(cols = -c(samplename), 
               names_to = "CellType", 
               values_to = "Proportion")

# Merge with sex_outcome from metadata
cibersort_long <- cibersort_long %>%
  left_join(metadata_quality %>% 
              select(samplename, sex_outcome), 
            by = "samplename")

# Create ridgeline plot
ggplot(cibersort_long, aes(x = Proportion, y = CellType, fill = sex_outcome)) +
  geom_density_ridges(alpha = 0.7, scale = 1.5) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 8)
  ) +
  labs(
    title = "Cell Type Proportions by Sex Outcome",
    x = "Proportion",
    fill = "Sex Outcome"
  ) +
  scale_fill_brewer(palette = "Set1")
```

## Sex specific Ridgeline plots

```{r}

library(patchwork)

# Remove specified columnsx
cibersort_plot_data <- cibersortx_stats %>% 
  select(-c(P.value, Correlation, RMSE))

# Reshape to long format
cibersort_long <- cibersort_plot_data %>%
  pivot_longer(cols = -c(samplename), 
               names_to = "CellType", 
               values_to = "Proportion")

# Merge with metadata
cibersort_long <- cibersort_long %>%
  left_join(metadata_quality %>% 
              select(samplename, Sex, Outcome), 
            by = "samplename")

# Plot for Female samples
female_plot <- ggplot(filter(cibersort_long, Sex == "F"), 
                      aes(x = Proportion, y = CellType, fill = Outcome)) +
  geom_density_ridges(alpha = 0.7, scale = 1.5) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 8)
  ) +
  labs(
    title = "Female Cell Type Proportions",
    x = "Proportion",
    fill = "Outcome"
  ) +
  scale_fill_brewer(palette = "Set1")

# Plot for Male samples
male_plot <- ggplot(filter(cibersort_long, Sex == "M"), 
                    aes(x = Proportion, y = CellType, fill = Outcome)) +
  geom_density_ridges(alpha = 0.7, scale = 1.5) +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_text(size = 8)
  ) +
  labs(
    title = "Male Cell Type Proportions",
    x = "Proportion",
    fill = "Outcome"
  ) +
  scale_fill_brewer(palette = "Set1")

# Combine plots
combined_plot <- female_plot + male_plot + 
  plot_layout(guides = "collect") & 
  theme(legend.position = "right")

# Display or save the combined plot
print(combined_plot)
```

# Stacked bar charts of cell-type proportions

```{r}
# Define a custom color palette with enough distinct colors
custom_colors <- c("#e6194b", "#3cb44b", "#ffe119", "#0082c8", "#f58231", "#911eb4", "#46f0f0", "#f032e6",
                   "#d2f53c", "#fabebe", "#008080", "#e6beff", "#aa6e28", "#fffac8", "#800000", "#aaffc3",
                   "#808000", "#ffd8b1", "#000080", "#808080", "#FFFFFF", "#000000")

# Define the new levels for sex_outcome
new_levels <- c("F_Control", "F_PE", "M_Control", "M_PE")

# create a long table format that combines the cell-type proportions with the PE outcome information
stacked_barchart_data <- dplyr::right_join(cibersortx_post_dedup_proportions, dplyr::select(metadata_quality, samplename, sex_outcome),
                                           by = "samplename") %>%
  mutate(sex_outcome = factor(sex_outcome, levels = new_levels)) %>%
  arrange(sex_outcome, samplename) %>%
  mutate(samplename = factor(samplename, levels = unique(samplename))) %>%
  melt()


# png(file=file.path(outdir, "post_dedup_stacked_proportions.png"),
#     width=14,
#     height=8,
#     units = "in",
#     res = 150)
ggplot(data = stacked_barchart_data,
       aes(x = samplename,
           y = value,
           fill = variable,
           label = sex_outcome)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = custom_colors) +
  labs(title = "Stacked Bar Chart of Post Deduplication Cell Type Proportions",
       x = "Samplename",
       y = "Cell Type Proportion",
       fill = "Cell Type") +
  theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.4)) +
    geom_text(aes(x = samplename,
                  y = 0.01,
                  label = sex_outcome),
            angle = 90,
            size = 3)
# dev.off()
```

# PCA and correlate 

```{r}
input_cibersortx_post_dedup_proportions_file <- file.path(projectDir, "deduplicated_clearBox/cibersortx_output/CIBERSORTx_Job10_Adjusted.txt")

# import the post deduplication cibersortx proportions
cibersort_proportions <- read.table(file = input_cibersortx_post_dedup_proportions_file,
                               header = TRUE,
                               sep = "\t") %>%
  dplyr::select(samplename = Mixture, everything()) %>%
  # remove the trailing "_dedup" from the samplename
  dplyr::mutate(samplename = gsub("_dedup$", "", samplename)) %>%
  # remove the stats we don't need
  dplyr::select(., -'P.value', -'Correlation', -'RMSE') %>%
  # keep only the 58 final samples
  inner_join(metadata[, c("samplename")], by = "samplename")


# Merge Mclust cluster information with cell type proportions
cluster_proportions <- data.frame(
  samplename = rownames(pca$x),
  Cluster = as.factor(mclust_result$classification)
) %>%
  left_join(cibersort_proportions, by = "samplename")

# Perform statistical tests for each cell type
# Using ANOVA to test if cell type proportions differ significantly across clusters
cell_types <- names(cibersort_proportions)[!(names(cibersort_proportions) %in% c("samplename"))]  # automatically select all columns except 'samplename'

anova_results <- lapply(cell_types, function(cell_type) {
  # ANOVA test
  aov_result <- aov(as.formula(paste(cell_type, "~ Cluster")), data = cluster_proportions)
  summary_aov <- summary(aov_result)
  
  # Return p-value
  data.frame(
    CellType = cell_type,
    p_value = summary_aov[[1]][["Pr(>F)"]][1]
  )
})

# Combine ANOVA results
anova_df <- do.call(rbind, anova_results)
anova_df$adjusted_p_value <- p.adjust(anova_df$p_value, method = "BH")

# Print significant cell types after multiple testing correction
print("Cell Types Significantly Different Across Clusters:")
print(anova_df[anova_df$adjusted_p_value < 0.05, ])

# Visualization of cell type proportions across clusters
library(ggplot2)
library(tidyr)

# Reshape data for plotting
plot_data <- cluster_proportions %>%
  pivot_longer(cols = cell_types, names_to = "CellType", values_to = "Proportion")

# Boxplot of cell type proportions by cluster
ggplot(plot_data, aes(x = Cluster, y = Proportion, fill = Cluster)) +
  geom_boxplot() +
  facet_wrap(~ CellType, scales = "free_y") +
  labs(title = "Cell Type Proportions Across Mclust Clusters",
       x = "Cluster", 
       y = "Proportion") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Correlation with PCA loadings
# Extract first few principal components
pca_loadings <- data.frame(
  samplename = rownames(pca$x),
  PC1 = pca$x[, 1],
  PC2 = pca$x[, 2]
) %>%
  left_join(cibersort_proportions, by = "samplename")

# Compute correlations between PCA loadings and cell type proportions
cor_results <- lapply(cell_types, function(cell_type) {
  # Correlation with PC1 and PC2
  cor_pc1 <- cor.test(pca_loadings$PC1, pca_loadings[[cell_type]])
  cor_pc2 <- cor.test(pca_loadings$PC2, pca_loadings[[cell_type]])
  
  data.frame(
    CellType = cell_type,
    PC1_correlation = cor_pc1$estimate,
    PC1_p_value = cor_pc1$p.value,
    PC2_correlation = cor_pc2$estimate,
    PC2_p_value = cor_pc2$p.value
  )
})

# Combine correlation results
cor_df <- do.call(rbind, cor_results)
cor_df$PC1_adjusted_p_value <- p.adjust(cor_df$PC1_p_value, method = "BH")
cor_df$PC2_adjusted_p_value <- p.adjust(cor_df$PC2_p_value, method = "BH")

# Print significant correlations
print("Significant Correlations with PCA Loadings:")
print(cor_df[cor_df$PC1_adjusted_p_value < 0.05 | cor_df$PC2_adjusted_p_value < 0.05, ])

# Scatter plots of significant correlations
significant_cell_types <- cor_df$CellType[cor_df$PC1_adjusted_p_value < 0.05 | cor_df$PC2_adjusted_p_value < 0.05]

#output directory
correlation_plots <- file.path(projectDir, "deduplicated_clearBox/output/correlation_plots")

for(cell_type in significant_cell_types) {
  # PC1 correlation plot
  p1 <- ggplot(pca_loadings, aes_string(x = "PC1", y = cell_type)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("PC1 vs", cell_type),
         x = "PC1", y = paste(cell_type, "Proportion")) +
    theme_minimal()
  
  # PC2 correlation plot
  p2 <- ggplot(pca_loadings, aes_string(x = "PC2", y = cell_type)) +
    geom_point() +
    geom_smooth(method = "lm") +
    labs(title = paste("PC2 vs", cell_type),
         x = "PC2", y = paste(cell_type, "Proportion")) +
    theme_minimal()
  
  # Save plots as PNG files
  ggsave(
    filename = file.path(correlation_plots, paste0(cell_type, "_PC1_correlation.png")), 
    plot = p1, 
    width = 10, 
    height = 6, 
    dpi = 300
  )
  
  ggsave(
    filename = file.path(correlation_plots, paste0(cell_type, "_PC2_correlation.png")), 
    plot = p2, 
    width = 10, 
    height = 6, 
    dpi = 300
  )
}
```

# Correlate gene expression with cell-type proportions
## Include genes that are both DE and in the cibersortx signature matrix  
- I will use the tpm matrix for the correlation as this is the table that is input into Cibersortx. Might not make any difference.  

```{r}

# put the hgnc symbol into the rownames for the tpm matrix
## drop rows with duplicate hgnc symbols
tpm_bulkCountMatrix_all_genes <- tpm_table[!duplicated(tpm_table$hgnc_symbol), ] %>%
  dplyr::select(., -SCP4060, -SCP3492, -SCP4010)
## ensure rownames are empty
rownames(tpm_bulkCountMatrix_all_genes) <- NULL
# move hgnc column to the rownames
tpm_bulkCountMatrix_all_genes %<>% tibble::column_to_rownames("hgnc_symbol")

# overlap between signature and DE genes - this is used to cut down the number of genes tested for correlation
topTable_male <- dplyr::filter(allTable_male, adj.P.Val < 0.05)
sig_de_overlap <- subset(cibersortx_reduced_sigMatrix, GeneSymbol %in% topTable_male$hgnc_symbol)
  

# Initialize an empty data frame to store correlation results
final_correlation_results <- data.frame(Cell_Type = names(sig_de_overlap)[-1], stringsAsFactors = FALSE)

# loop through the genes and correlate with cell-type proportions
for (i in 1:nrow(sig_de_overlap)) {
  
  sig_de_overlap_ensbl <- dplyr::left_join(sig_de_overlap, topTable_male[, c("ensembl", "hgnc_symbol")], by = c("GeneSymbol" = "hgnc_symbol")) %>%
    dplyr::select(., GeneSymbol, ensembl, everything())
  
  GOI_ensbl <- paste0(sig_de_overlap_ensbl$ensembl_gene_id[i])
  GOI_hgnc <- paste0(sig_de_overlap_ensbl$GeneSymbol[i])
  
  cibersortx_proportion_rownames <- cibersortx_post_dedup_proportions %>%
    tibble::column_to_rownames("samplename")

  tpm_GOI <- reshape2::melt(
  subset(tpm_bulkCountMatrix_all_genes, rownames(tpm_bulkCountMatrix_all_genes) %in% sig_de_overlap_ensbl$GeneSymbol[i]) %>%
    tibble::rownames_to_column()
  ) %>% 
    as.data.frame() %>% 
    set_colnames(c("ensbl", "samplename", paste0(sig_de_overlap_ensbl$ensembl[i]))) %>% 
    dplyr::select(., -ensbl) %>%
    dplyr::left_join(., cibersortx_post_dedup_proportions, by = "samplename") %>%
    dplyr::select(., -samplename)
  
  # Calculate correlations between gene expression and cell type proportions for each cell type
  correlations <- lapply(colnames(tpm_GOI)[-1], function(cell_type) {
    cor(tpm_GOI[[1]], tpm_GOI[[cell_type]])
  })
  
  # Combine correlations into a data frame
  correlation_results <- data.frame(names(tpm_GOI)[-1])
  
  # Add correlation results for the current gene as new columns
  colnames(correlation_results) <- paste(GOI_hgnc)
  correlation_results[] <- unlist(correlations)
  
  # Append the current gene's correlation results to the final data frame
  final_correlation_results <- cbind(final_correlation_results, correlation_results)
  
}

dim_final_correlation_all_samples <- dim(final_correlation_results)

# prepare the correlations for plotting
final_correlation_results <- final_correlation_results %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
    column_to_rownames("Cell_Type")

# png(file=file.path(outdir, "post_dedup_correlation_heatmap.png"),
#     width=12,
#     height=8,
#     units = "in",
#     res = 150)
pheatmap(final_correlation_results)
# dev.off()
```

## Male samples only
### Only genes that are in both the DE ad signature matrix
```{r}
# create a vector of male sample IDs
male_samplename <- metadata_quality %>%
  filter(Sex == "M") %>%
  pull(samplename)

# put the hgnc symbol into the rownames for the tpm matrix
## drop rows with duplicate hgnc symbols
tpm_bulkCountMatrix_all_genes_male <- tpm_table[!duplicated(tpm_table$hgnc_symbol), ]
tpm_bulkCountMatrix_all_genes_male <- tpm_bulkCountMatrix_all_genes_male[, c("hgnc_symbol", male_samplename)]
## ensure rownames are empty
rownames(tpm_bulkCountMatrix_all_genes_male) <- NULL
# move hgnc column to the rownames
tpm_bulkCountMatrix_all_genes_male %<>% tibble::column_to_rownames("hgnc_symbol")

# overlap between signature and DE genes - this is used to cut down the number of genes tested for correlation
topTable_male <- dplyr::filter(allTable_male, adj.P.Val < 0.05)
sig_de_overlap <- subset(cibersortx_reduced_sigMatrix, GeneSymbol %in% topTable_male$hgnc_symbol)
  

# Initialize an empty data frame to store correlation results
final_correlation_results <- data.frame(Cell_Type = names(sig_de_overlap)[-1], stringsAsFactors = FALSE)

# loop through the genes and correlate with cell-type proportions
for (i in 1:nrow(sig_de_overlap)) {
  
  # Join sig_de_overlap with topTable_male to get the ensembl IDs
  sig_de_overlap_ensbl <- dplyr::left_join(sig_de_overlap, topTable_male[, c("ensembl", "hgnc_symbol")], by = c("GeneSymbol" = "hgnc_symbol")) %>%
    dplyr::select(., GeneSymbol, ensembl, everything())
  
  GOI_ensbl <- paste0(sig_de_overlap_ensbl$ensembl_gene_id[i])
  GOI_hgnc <- paste0(sig_de_overlap_ensbl$GeneSymbol[i])
  
  cibersortx_proportion_rownames <- cibersortx_post_dedup_proportions %>%
    tibble::column_to_rownames("samplename")
  
  tpm_GOI <- reshape2::melt(
  subset(tpm_bulkCountMatrix_all_genes_male, rownames(tpm_bulkCountMatrix_all_genes_male) %in% sig_de_overlap_ensbl$GeneSymbol[i]) %>%
    tibble::rownames_to_column()
  ) %>% 
    as.data.frame() %>% 
    set_colnames(c("ensbl", "samplename", paste0(sig_de_overlap_ensbl$ensembl[i]))) %>% 
    dplyr::select(., -ensbl) %>%
    dplyr::left_join(., cibersortx_post_dedup_proportions, by = "samplename") %>%
    dplyr::select(., -samplename)

  # Calculate correlations between gene expression and cell type proportions for each cell type
  correlations <- lapply(colnames(tpm_GOI)[-1], function(cell_type) {
    cor(tpm_GOI[[1]], tpm_GOI[[cell_type]])
  })
  
  # Combine correlations into a data frame
  correlation_results <- data.frame(names(tpm_GOI)[-1])
  
  # Add correlation results for the current gene as new columns
  colnames(correlation_results) <- paste(GOI_hgnc)
  correlation_results[] <- unlist(correlations)
  
  # Append the current gene's correlation results to the final data frame
  final_correlation_results <- cbind(final_correlation_results, correlation_results)
  
}

# prepare the correlations for plotting
final_correlation_results_plot_male <- final_correlation_results %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
    column_to_rownames("Cell_Type")

# Format the numbers to two decimal places
formatted_numbers <- apply(final_correlation_results_plot_male, 2, function(x) sprintf("%.2f", x))

dim_final_correlation_males <- dim(final_correlation_results) # 20 44

png(file=file.path(outdir, "male_post_dedup_correlation_heatmap.png"),
    width=14,
    height=8,
    units = "in",
    res = 150)
pheatmap(final_correlation_results_plot_male,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
  display_numbers = formatted_numbers,
  number_fontsize = 9,
  main = "Correlations between expression of DE genes and cell types - Male")
dev.off()
```

### All DE genes

```{r}
# create a vector of male sample IDs
male_samplename <- metadata_quality %>%
  filter(Sex == "M") %>%
  pull(samplename)

# put the hgnc symbol into the rownames for the tpm matrix
## drop rows with duplicate hgnc symbols
tpm_bulkCountMatrix_all_genes_male <- tpm_table[!duplicated(tpm_table$hgnc_symbol), ]
tpm_bulkCountMatrix_all_genes_male <- tpm_bulkCountMatrix_all_genes_male[, c("hgnc_symbol", male_samplename)]
## ensure rownames are empty
rownames(tpm_bulkCountMatrix_all_genes_male) <- NULL
# move hgnc column to the rownames
tpm_bulkCountMatrix_all_genes_male %<>% tibble::column_to_rownames("hgnc_symbol")

# overlap between signature and DE genes - this is used to cut down the number of genes tested for correlation
## genes with 95% confidence
# topTable_male <- dplyr::filter(allTable_male, adj.P.Val < 0.05)
## genes with 80% confidence
topTable_male <- dplyr::filter(allTable_male, adj.P.Val < 0.20)
# sig_de_overlap <- subset(cibersortx_reduced_sigMatrix, GeneSymbol %in% topTable_male$hgnc_symbol)
  

# Initialize an empty data frame to store correlation results
final_correlation_results <- data.frame(Cell_Type = names(cibersortx_post_dedup_proportions)[-1], stringsAsFactors = FALSE)

# loop through the genes and correlate with cell-type proportions
for (i in 1:nrow(topTable_male)) {
  
  # Join sig_de_overlap with topTable_male to get the ensembl IDs
  # sig_de_overlap_ensbl <- dplyr::left_join(sig_de_overlap, topTable_male[, c("ensembl", "hgnc_symbol")], by = c("GeneSymbol" = "hgnc_symbol")) %>%
  #   dplyr::select(., GeneSymbol, ensembl, everything())
  
  GOI_ensbl <- paste0(topTable_male$ensembl[i])
  GOI_hgnc <- paste0(topTable_male$hgnc_symbol[i])
  
  cibersortx_proportion_rownames <- cibersortx_post_dedup_proportions %>%
    tibble::column_to_rownames("samplename")
  
  tpm_GOI <- reshape2::melt(
  subset(tpm_bulkCountMatrix_all_genes_male, rownames(tpm_bulkCountMatrix_all_genes_male) %in% topTable_male$hgnc_symbol[i]) %>%
    tibble::rownames_to_column()
  ) %>% 
    as.data.frame() %>% 
    set_colnames(c("ensembl", "samplename", paste0(topTable_male$ensembl[i]))) %>% 
    dplyr::select(., -ensembl) %>%
    dplyr::left_join(., cibersortx_post_dedup_proportions, by = "samplename") %>%
    dplyr::select(., -samplename)

  # Calculate correlations between gene expression and cell type proportions for each cell type
  correlations <- lapply(colnames(tpm_GOI)[-1], function(cell_type) {
    cor(tpm_GOI[[1]], tpm_GOI[[cell_type]])
  })
  
  # Combine correlations into a data frame
  correlation_results <- data.frame(names(tpm_GOI)[-1])
  
  # Add correlation results for the current gene as new columns
  colnames(correlation_results) <- paste(GOI_hgnc)
  correlation_results[] <- unlist(correlations)
  
  # Append the current gene's correlation results to the final data frame
  final_correlation_results <- cbind(final_correlation_results, correlation_results)
  
}

# prepare the correlations for plotting
final_correlation_results_plot_male <- final_correlation_results %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
    column_to_rownames("Cell_Type")

write_csv(final_correlation_results,
          file = out_final_correlation_results_80percent_file,
          col_names = TRUE)

# Format the numbers to two decimal places
formatted_numbers <- apply(final_correlation_results_plot_male, 2, function(x) sprintf("%.2f", x))

dim_final_correlation_males <- dim(final_correlation_results) # 20 44

annotation_DE <- topTable_male %>%
    mutate(DE_direction = case_when(
    logFC > 0 ~ "up_regulated",
    logFC <= 0 ~ "down_regulated"
  )) %>%
  dplyr::select(., hgnc_symbol, DE_direction) %>%
  tibble::column_to_rownames("hgnc_symbol")

# png(file=file.path(outdir, "male_post_dedup_correlation_heatmap_80percent_DE.png"),
#     width=14,
#     height=8,
#     units = "in",
#     res = 150)
pheatmap(final_correlation_results_plot_male,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         show_colnames = FALSE,
         annotation_col = annotation_DE,
  main = "Correlations between expression of DE genes and cell types - Male")
# dev.off()
```


### Sanity plot of male proportions by outcome
- The correlation heatmaps show a strong correlation between many cell types and the expression of DE genes.  
- Here I will plot the cell-type proportions for male uncomplicated and male PE. If these cell type proportions are driving the DE we should see a difference in cell-type proportions between the PE and uncomplicated group. This might be difficult to see with only 5 PE boys (ie not much scatter).  

```{r}

cell_type <- "Fetal.Fibroblasts"
cibersortx_post_dedup_proportions %>%
  left_join(metadata_quality[, c("samplename", "sex_outcome")], by = "samplename") %>%
  filter(!samplename %in% c("SCP3492", "SCP4010", "SCP4060")) %>%
  melt(.) %>%
  dplyr::filter(variable == cell_type) %>%
  ggplot(aes(x = sex_outcome, y = value, fill = sex_outcome)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Sex Outcome", y = cell_type, fill = "Sex Outcome") +
  theme_minimal()

```
## Female samples only

```{r}
# create a vector of male sample IDs
female_samplename <- metadata_quality %>%
  filter(Sex == "F") %>%
  pull(samplename)

# put the hgnc symbol into the rownames for the tpm matrix
## drop rows with duplicate hgnc symbols
tpm_bulkCountMatrix_all_genes_female <- tpm_table[!duplicated(tpm_table$hgnc_symbol), ]
tpm_bulkCountMatrix_all_genes_female <- tpm_bulkCountMatrix_all_genes_female[, c("hgnc_symbol", female_samplename)]
## ensure rownames are empty
rownames(tpm_bulkCountMatrix_all_genes_female) <- NULL
# move hgnc column to the rownames
tpm_bulkCountMatrix_all_genes_female %<>% tibble::column_to_rownames("hgnc_symbol")

# overlap between signature and DE genes - this is used to cut down the number of genes tested for correlation
topTable_male <- dplyr::filter(allTable_male, adj.P.Val < 0.05)
sig_de_overlap <- subset(cibersortx_reduced_sigMatrix, GeneSymbol %in% topTable_male$hgnc_symbol)
  

# Initialize an empty data frame to store correlation results
final_correlation_results <- data.frame(Cell_Type = names(sig_de_overlap)[-1], stringsAsFactors = FALSE)

# loop through the genes and correlate with cell-type proportions
for (i in 1:nrow(sig_de_overlap)) {
  
  # Join sig_de_overlap with topTable_male to get the ensembl IDs
  sig_de_overlap_ensbl <- dplyr::left_join(sig_de_overlap, topTable_male[, c("ensembl", "hgnc_symbol")], by = c("GeneSymbol" = "hgnc_symbol")) %>%
    dplyr::select(., GeneSymbol, ensembl, everything())
  
  GOI_ensbl <- paste0(sig_de_overlap_ensbl$ensembl_gene_id[i])
  GOI_hgnc <- paste0(sig_de_overlap_ensbl$GeneSymbol[i])
  
  cibersortx_proportion_rownames <- cibersortx_post_dedup_proportions %>%
    tibble::column_to_rownames("samplename")
  
  tpm_GOI <- reshape2::melt(
  subset(tpm_bulkCountMatrix_all_genes_female, rownames(tpm_bulkCountMatrix_all_genes_female) %in% sig_de_overlap_ensbl$GeneSymbol[i]) %>%
    tibble::rownames_to_column()
  ) %>% 
    as.data.frame() %>% 
    set_colnames(c("ensbl", "samplename", paste0(sig_de_overlap_ensbl$ensembl[i]))) %>% 
    dplyr::select(., -ensbl) %>%
    dplyr::left_join(., cibersortx_post_dedup_proportions, by = "samplename") %>%
    dplyr::select(., -samplename)

  # Calculate correlations between gene expression and cell type proportions for each cell type
  correlations <- lapply(colnames(tpm_GOI)[-1], function(cell_type) {
    cor(tpm_GOI[[1]], tpm_GOI[[cell_type]])
  })
  
  # Combine correlations into a data frame
  correlation_results <- data.frame(names(tpm_GOI)[-1])
  
  # Add correlation results for the current gene as new columns
  colnames(correlation_results) <- paste(GOI_hgnc)
  correlation_results[] <- unlist(correlations)
  
  # Append the current gene's correlation results to the final data frame
  final_correlation_results <- cbind(final_correlation_results, correlation_results)
  
}

dim_final_correlation_females <- dim(final_correlation_results) # 20 44

# prepare the correlations for plotting
final_correlation_results_plot_female <- final_correlation_results %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
    column_to_rownames("Cell_Type")

# Format the numbers to two decimal places
formatted_numbers <- apply(final_correlation_results_plot_female, 2, function(x) sprintf("%.2f", x))

# png(file=file.path(outdir, "female_post_dedup_correlation_heatmap.png"),
#     width=14,
#     height=8,
#     units = "in",
#     res = 150)
pheatmap(final_correlation_results_plot_female,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
  display_numbers = formatted_numbers,
  number_fontsize = 9,
  main = "Correlations between expression of DE genes and cell types - Female")
# dev.off()
```
### All DE genes

```{r}
# create a vector of male sample IDs
female_samplename <- metadata_quality %>%
  filter(Sex == "F") %>%
  pull(samplename)

# put the hgnc symbol into the rownames for the tpm matrix
## drop rows with duplicate hgnc symbols
tpm_bulkCountMatrix_all_genes_female <- tpm_table[!duplicated(tpm_table$hgnc_symbol), ]
tpm_bulkCountMatrix_all_genes_female <- tpm_bulkCountMatrix_all_genes_female[, c("hgnc_symbol", female_samplename)]
## ensure rownames are empty
rownames(tpm_bulkCountMatrix_all_genes_female) <- NULL
# move hgnc column to the rownames
tpm_bulkCountMatrix_all_genes_female %<>% tibble::column_to_rownames("hgnc_symbol")

# overlap between signature and DE genes - this is used to cut down the number of genes tested for correlation
topTable_male <- dplyr::filter(allTable_male, adj.P.Val < 0.05)
# sig_de_overlap <- subset(cibersortx_reduced_sigMatrix, GeneSymbol %in% topTable_male$hgnc_symbol)
  

# Initialize an empty data frame to store correlation results
final_correlation_results <- data.frame(Cell_Type = names(cibersortx_post_dedup_proportions)[-1], stringsAsFactors = FALSE)

# loop through the genes and correlate with cell-type proportions
for (i in 1:nrow(topTable_male)) {
  
  # Join sig_de_overlap with topTable_male to get the ensembl IDs
  # sig_de_overlap_ensbl <- dplyr::left_join(sig_de_overlap, topTable_male[, c("ensembl", "hgnc_symbol")], by = c("GeneSymbol" = "hgnc_symbol")) %>%
  #   dplyr::select(., GeneSymbol, ensembl, everything())
  
  GOI_ensbl <- paste0(topTable_male$ensembl[i])
  GOI_hgnc <- paste0(topTable_male$hgnc_symbol[i])
  
  cibersortx_proportion_rownames <- cibersortx_post_dedup_proportions %>%
    tibble::column_to_rownames("samplename")
  
  tpm_GOI <- reshape2::melt(
  subset(tpm_bulkCountMatrix_all_genes_female, rownames(tpm_bulkCountMatrix_all_genes_female) %in% topTable_male$hgnc_symbol[i]) %>%
    tibble::rownames_to_column()
  ) %>% 
    as.data.frame() %>% 
    set_colnames(c("ensembl", "samplename", paste0(topTable_male$ensembl[i]))) %>% 
    dplyr::select(., -ensembl) %>%
    dplyr::left_join(., cibersortx_post_dedup_proportions, by = "samplename") %>%
    dplyr::select(., -samplename)

  # Calculate correlations between gene expression and cell type proportions for each cell type
  correlations <- lapply(colnames(tpm_GOI)[-1], function(cell_type) {
    cor(tpm_GOI[[1]], tpm_GOI[[cell_type]])
  })
  
  # Combine correlations into a data frame
  correlation_results <- data.frame(names(tpm_GOI)[-1])
  
  # Add correlation results for the current gene as new columns
  colnames(correlation_results) <- paste(GOI_hgnc)
  correlation_results[] <- unlist(correlations)
  
  # Append the current gene's correlation results to the final data frame
  final_correlation_results <- cbind(final_correlation_results, correlation_results)
  
}

# prepare the correlations for plotting
final_correlation_results_plot_female <- final_correlation_results %>%
  mutate_all(~replace(., is.na(.), 0)) %>%
    column_to_rownames("Cell_Type")

dim_final_correlation_females <- dim(final_correlation_results) # 20 44

annotation_DE <- topTable_male %>%
    mutate(DE_direction = case_when(
    logFC > 0 ~ "up_regulated",
    logFC <= 0 ~ "down_regulated"
  )) %>%
  dplyr::select(., hgnc_symbol, DE_direction) %>%
  tibble::column_to_rownames("hgnc_symbol")

# png(file=file.path(outdir, "female_post_dedup_correlation_heatmap_all_DE.png"),
#     width=14,
#     height=8,
#     units = "in",
#     res = 150)
pheatmap(final_correlation_results_plot_female,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         annotation_col = annotation_DE,
  main = "Correlations between expression of DE genes and cell types - Female")
# dev.off()
```

## Compare cell type proportions and correlations between sex

```{r}

rownames(final_correlation_results_plot_female) <- paste0(rownames(final_correlation_results_plot_female), "_female")
rownames(final_correlation_results_plot_male) <- paste0(rownames(final_correlation_results_plot_male), "_male")

heatmap_data <- rbind(final_correlation_results_plot_male, final_correlation_results_plot_female)


png(file=file.path(outdir, "compare_male_female_cor_heatmap.png"),
    width=14,
    height=8,
    units = "in",
    res = 150)
pheatmap(heatmap_data[c("Fetal.Mesenchymal.Stem.Cells_male", "Fetal.Mesenchymal.Stem.Cells_female", "Fetal.Fibroblasts_male", "Fetal.Fibroblasts_female"),],
         annotation = annotation_DE,
         cluster_cols = TRUE,
         cluster_rows = FALSE,
         main = "Compare Correlations between Male and Female")
dev.off()
```

## Compare mean proportions between male and female

```{r}
compare_proportions <- dplyr::left_join(cibersortx_post_dedup_proportions, metadata_quality[, c("samplename", "Sex", "sex_outcome")], by = "samplename") %>%
  subset(., samplename %notin% c("SCP4010", "SCP4060", "SCP3492")) %>%
  group_by(., Sex)

# Calculate the mean of columns grouped by Sex, excluding specific columns
mean_proportions <- compare_proportions %>%
  group_by(sex_outcome) %>%
  summarise(across(-c(samplename, Sex),
                   mean,
                   na.rm = TRUE)) %>%
  pivot_longer(cols = -sex_outcome,
               names_to = "cell_type",
               values_to = "mean_proportion") %>%
  pivot_wider(names_from = sex_outcome,
              values_from = mean_proportion)

```

## Plot gene expression (x-axis) and cell-type proportion (y)

```{r}

cpms <- edgeR::cpm(dge_list_obj, log = FALSE)

# Filter allTable_male to get ensembl IDs with adj.P.Val < 0.05
filtered_ensembl <- allTable_male %>%
  filter(adj.P.Val < 0.05) %>%
  pull(ensembl)

# Create a data frame with CPM values for the filtered ensembl IDs
cpm_DE_genes <- cpms %>%
  data.frame() %>%
  tibble::rownames_to_column("ensembl") %>%
  filter(ensembl %in% filtered_ensembl)


temp <- cpm_DE_genes %>% tibble::column_to_rownames("ensembl") %>%
  t() %>%
  data.frame() %>%
  tibble::rownames_to_column("samplename") %>%
  dplyr::left_join(., compare_proportions, by = "samplename")



ggplot(data = temp,
       aes(x = ENSG00000198108,
           y = Fetal.Mesenchymal.Stem.Cells,
           colour = sex_outcome)) +
  geom_point() +
  labs(title = "ENSG00000198108 CHSY3 logFC 1.096",
       x = "ENSG00000198108 CHSY3 (CPM)",
       y = "Fetal.Mesenchymal.Stem.Cells",
       fill = "Sex Outcome") +
  theme_minimal()
```



